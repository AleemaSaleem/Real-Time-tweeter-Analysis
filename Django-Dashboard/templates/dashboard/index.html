{% extends 'base.html' %}
{% load static %}

{% block title %} Big Data Project {% endblock title %}


{% block links %}
    <!-- <link rel="stylesheet" href="{% static 'css/css-reset.css' %}"> -->
    <!-- <link rel="stylesheet" href="{% static 'css/normalize.css' %}"> -->
    <link rel="stylesheet" href="{% static 'css/myCss-fm.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
{% endblock links %}


{% block content %}

<header>
    <div class="container flex-sp-bet">
        <a href="{% url 'dashboard' %}">
            <h2 class="logo"> Real-Time Twitter Sentiment Analysis</h2>
        </a>
        <nav class="nav">
            <ul>
                <li><a href="{% url 'dashboard' %}"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li><a href="{% url 'classify' %}"><i class="fa-solid fa-user-pen"></i> Classify</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="main-section fade-in">
    {% if len_data != 0 %}
    <section class="intro">
        <h1>Sentiment Analysis Overview</h1>
        <p>Analyze real-time Twitter data and visualize sentiment distribution and word frequencies.</p>
    </section>

    <section class="data-section">
        <div class="section-header">
            <h2 class="section-title">Dataset Preview</h2>
            <div class="dropdown-wrapper">
                <label for="recordLimit">Show:</label>
                <select id="recordLimit">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>records</span>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="styled-table" id="tweetTable">
                <thead>
                    <tr>
                        <th>Tweet</th>
                        <th>Predicted Sentiment</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    <tr>
                        <td>{{ item.tweet }}</td>
                        <td>
                            <span class="badge 
                                {% if item.prediction == 'Positive' %}positive
                                {% elif item.prediction == 'Negative' %}negative
                                {% else %}neutral{% endif %}">
                                {{ item.prediction }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <section class="stats-section">
        <h2 class="section-title">Data Statistics</h2>

        <div class="stats-summary">
            <p>Total Records: <strong>{{ len_data }}</strong></p>
        </div>

        <div class="chart-grid small-chart">
            <div class="chart-card">
                <canvas id="myChart1" width="220" height="220"></canvas>
            </div>
            <div class="chart-info">
                <h3>Sentiment Distribution</h3>
                <ul class="stats-list">
                    {% for label, rate in sentiment_rates.items %}
                    <li><span>{{ label }}</span> <strong>{{ rate }}%</strong></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </section>

    <section class="wordcloud-section">
        <h2 class="section-title">Top Word Frequencies</h2>
        <div class="wordcloud-container">
            <img src="{% static 'imgs/Word_Frequencies_for_all_classes.png' %}" alt="Word Frequencies" class="wordcloud-img small-img">
        </div>
    </section>

    {% else %}
    <div class="empty-state">
        <h2>No data available</h2>
        <p>Your database is currently empty. Please run the data ingestion pipeline.</p>
    </div>
    {% endif %}
</main>
{% endblock content %}

{% block scripts %}
<script src="{% static 'js/script.js' %}"></script>

<script>
    // ---- Chart.js (refreshed colors + smaller size) ----
    const sentimentCounts = {{ sentiment_counts|safe }};
    const labels = Object.keys(sentimentCounts);
    const values = Object.values(sentimentCounts);

    const ctx = document.getElementById('myChart1').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: [
                    '#2563EB', // blue
                    '#16A34A', // green
                    '#EAB308', // yellow
                    '#DC2626'  // red
                ],
                borderWidth: 0,
                hoverOffset: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 15,
                        font: { size: 13, weight: '500' },
                        color: '#333'
                    }
                }
            },
            cutout: '65%'
        }
    });

    // ---- Dropdown to limit records ----
    const recordLimitSelect = document.getElementById('recordLimit');
    const table = document.getElementById('tweetTable');
    const rows = Array.from(table.querySelectorAll('tbody tr'));

    function updateTable(limit) {
        rows.forEach((row, index) => {
            row.style.display = index < limit ? '' : 'none';
        });
    }

    updateTable(10); // default to 10
    recordLimitSelect.addEventListener('change', () => {
        updateTable(parseInt(recordLimitSelect.value));
    });
</script>
{% endblock scripts %}
